<script src='/assets/js/berryApp.js'></script> 

		<link rel='stylesheet' type='text/css' href='/assets/css/cobler.css'>
		<script type="text/javascript" src="/assets/js/sortable.js"></script>
		<script type='text/javascript' src='/assets/js/cob/cob.js'></script>
		<script type='text/javascript' src='/assets/js/cob/content.cob.js'></script>
		<script type='text/javascript' src='/assets/js/cob/uapp.cob.js'></script>
		<!-- // <script type='text/javascript' src='assets/js/form.cob.js'></script>		 -->
		<script type='text/javascript' src='//cdn.tinymce.com/4/tinymce.min.js'></script>`
		<script type='text/javascript' src='/assets/js/templates/widget.js'></script>
	    <script src='/assets/js/lib.js'></script> 

		<script type='text/template' name="widgets_container">
			<div style="position:relative">
				<div class="cobler-li-content widget"></div>
				<div class="btn-group parent-hover" style="position:absolute;top:5px;right:5px">
					<span class="edit-item btn btn-default fa fa-pencil" data-title="Edit"></span>
				</div>			
			</div>
		</script>
		<script type='text/template' name="widgets_container_edit">
			<div style="position:relative">
				<div class="cobler-li-content widget"></div>
				<div class="btn-group parent-hover" style="position:absolute;top:5px;right:5px">
					<span class="remove-item btn btn-danger fa fa-trash-o" data-title="Remove"></span>
					<span class="duplicate-item btn btn-default fa fa-copy" data-title="Duplicate"></span>
					<span class="edit-item btn btn-default fa fa-pencil" data-title="Edit"></span>
				</div>			
			</div>
		</script>
		<script type='text/template' name="widgets_container_app">
			<div style="position:relative">
				<div class="cobler-li-content widget"></div>		
			</div>
		</script>
		<script type='text/javascript' >
      _.findWhere = _.find;
	  _.where = _.filter;



layouts = [
		{
			value: '0',
			classes: 'bu-3-6-3',
			title: 'Wide Middle (3-6-3)',
			label: '<i title="Wide Middle" class="bu-3-6-3"></i>',
			template: '<div class="col-md-3 col-sm-4 cobler_container"></div><div class="col-sm-8 col-md-6 cobler_container"></div><div class="col-md-3 col-sm-12 cobler_container"></div>'
		},
		{
			value: '1',
			classes: 'bu-6-3-3',
			title: 'Wide Left (6-3-3)',
			label: '<i title="Wide Left" class="bu-6-3-3"></i>',
			template: '<div class="col-md-6 col-sm-8 cobler_container"></div><div class="col-md-3 col-sm-4 cobler_container"></div><div class="col-md-3 col-sm-12 cobler_container"></div>'
		},
		{
			value: '2',
			classes: 'bu-4-4-4',
			title: 'Even (4-4-4)',
			label: '<i title="Even" class="bu-4-4-4"></i>',
			template: '<div class="col-md-4 col-sm-6 cobler_container"></div><div class="col-md-4 col-sm-6 cobler_container"></div><div class="col-md-4 col-sm-12 cobler_container"></div>'
		},
		{
			value: '3',
			classes: 'bu-6-6',
			title: 'Split (6-6)',
			label: '<i title="Split" class="bu-6-6"></i>',
			template: '<div class="col-sm-6 cobler_container"></div><div class="col-sm-6 cobler_container"></div>'
		},
		{
			value: '4',
			classes: 'bu-12-12',
			title: 'Full Page (12)',
			label: '<i title="Full" class="bu-12-12"></i>',
			template: '<div class="col-lg-12 cobler_container"></div>'
		},
		{
			value: '5',
			classes: 'bu-oddshape',
			title: 'Odd Shape',
			label: '<i title="Odd Split" class="bu-oddshape"></i>',
			template: '<div class="col-sm-4 cobler_container"></div><div class="col-sm-8"><div class="row"><div class="col-sm-12 cobler_container"></div></div><div class="row"><div class="col-sm-6 cobler_container"></div><div class="col-sm-6 cobler_container"></div></div></div>'
		},
		{
			value: '6',
			classes: 'bu-doubledown',
			title: 'Double Down (12 6-6 12)',
			label: '<i title="Double Down" class="bu-doubledown"></i>',
			template: '<div class="col-sm-12"><div class="row"><div class="col-sm-12 cobler_container"></div></div><div class="row"> <div class="col-sm-6 cobler_container"></div><div class="col-sm-6 cobler_container"></div></div><div class="row"><div class="col-sm-12 cobler_container"></div></div></div>'
		},
		{
			value: '7',
			classes: 'bu-3-6-3',
			title: 'Middle Only (_-6-_)',
			label: '<i title="Middle Only" class="bu-3-6-3"></i>',
			template: '<div class="col-lg-offset-3 col-md-offset-2  col-lg-6 col-md-8 col-sm-12 cobler_container"></div></div>'
		},
	];

			function layout() {
				var berry = $().berry({
					legend: 'Change Layout', 
					inline:false,
					fields:[
						{
							label:'Layout',
							name:'layout',
							label_key:'title',
							classes: layouts[config.layout||0].classes, 
							choices: layouts, 
							value: config.layout
						}
					]
				}).on('save',function(){
					$.ajax({
						url:'/api/pages/{{id}}',
						data:{content: $.extend({}, config,{layout:parseInt(this.toJSON().layout)})},
						method:'PUT',
						success: function(data) {
							config = data.content;
							location.reload()
						}
					})
				});
			}
				if(typeof appMode !== 'undefined'){
					templates['widgets_container_app'] = Hogan.compile(document.getElementsByName('widgets_container_app')[0].innerHTML);
				}else{
					templates['widgets_container'] = Hogan.compile(document.getElementsByName('widgets_container')[0].innerHTML);
				}
				templates['widgets_container_edit'] = Hogan.compile(document.getElementsByName('widgets_container_edit')[0].innerHTML);
			function load(status){
				$('body').toggleClass('editor', !status)
				if(typeof cb !== 'undefined'){
					cb.destroy();
					delete cb;
				}
				var template = 'widgets_container'
				var target = 'widget';
				if(!status){
					template = 'widgets_container_edit';
				}


				var data = config.sections || [[]];// [[{"title":"This is the title","app_id":1,"widgetType":"uApp"}]];
				$('#page_layout').html(layouts[config.layout || 0].template);

				cb = new Cobler({ disabled: status, targets: document.getElementsByClassName('cobler_container'),itemContainer: template,itemTarget:target, items:data})

				if(!status){
					cb.addSource(document.getElementById('sortableList'));
					if('{{name}}' == 'Dashboard'){
						var save = function(){$.post('/api/dashboard',{"config":{"sections":cb.toJSON({editor: true})} },function(data){
							// config = JSON.parse(data.config);
							config = data.config;
						})}
					}else{
						var save = function(){$.ajax({
							url:'/api/pages/{{id}}',
							data:{"content":{"sections":cb.toJSON({editor: true}),"layout":config.layout} },
							method:'PUT',
							success: function(data){
								config = data.content;
							}
						})}
					}
					cb.on('moved',save);
					cb.on('reorder', save);
					cb.on('remove', save);
					cb.on('change',save);
				}
			}

			function addWidget(e) { cb.collections[0].addItem(e); }
			var config = {{{config_json}}};
      		var apps = {{{apps_json}}};
			// var status = true;
			load(true);
  		$('[href$="{{slug}}"]').parent().addClass('active').parent().addClass('in');

		</script>

		<script type='text/javascript' >
			$('body').keydown(function(event) {
				switch(event.keyCode) {
					case 27://escape
							cb.deactivate();
						break;
				}
			});
		</script>
