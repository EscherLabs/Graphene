function cobler(e){this.clear=function(){this.deselect(),$("#cb-content").empty(),this.slices=[],this.$el.find("#cb-starter").remove(),this.$el.find("#cb-content").remove(),this.options.editable?(this.$el.append(Berry.render("cobler_init_cobler",this,e)),$("#cb-content").sortable({cursor:"move",items:"li:not(.locked)",placeholder:"cb-placeholder",forcePlaceholderSize:!0,axis:this.options.axis,start:function(e,t){$(".cb-placeholder").attr("data-name",$(t.item[0]).attr("data-name")).addClass($(t.item[0]).attr("class"))},stop:$.proxy(function(e,t){this.slices.splice($(t.item).index(),0,this.slices.splice(o($(t.item).attr("id")),1)[0]),cobler.changed=!0},this),cancel:"#cb-content li .cobler-li-content, #cb-content li.locked",receive:function(){n=null}})):this.$el.append(Formal.render("cobler_init_cobler_noedit",this,e))},this.reload=function(){var e=this.toJSON();this.clear(),this.load(e)},this.load=function(e){this.clear();for(var t in e){$("#cb-starter").hide();var i=new cobler.types[e[t].widgetType](this,e[t]);i.validate(e[t],!1)&&($(i.createEL()).appendTo("#cb-content"),this.slices.push(i)),i.callback&&i.callback.call(i)}},this.toJSON=function(e){var e=$.extend({},this.options,e);if(e.associative){json={};for(var t in this.slices)json[this.slices[t].uuid]=this.slices[t].attributes;return json}json=[];for(var t in this.slices)json.push(this.slices[t].attributes);return json},this.toHTML=function(){var e=$("<div/>");for(var t in this.slices)e.append(this.slices[t].$el.find(".cobler-li-content").html());return e.html()},this.add=function(e,i){var s=new cobler.types[e](this,i);s.validate(s.defaults,!1)&&(this.slices.push(s),t(s.createEL().appendTo("#cb-content").hide().show("highlight")),$("#cb-starter").hide())},this.updateWidget=function(e){cobler.changed=!0,this.selected&&(this.selected.toJSON(),(1==e.force||1==this.form.find(e.path).force||this.selected.contentFields!==!0)&&(r.selected.editView?this.selected.$el.find(".cobler-li-content").html(this.selected.editView()):this.selected.$el.replaceWith($(this.selected.createEL()).addClass("selected"))),this.selected.callback&&this.selected.callback.call(this.selected))},this.deselect=function(){r.selected&&(this.form&&(this.updateWidget({force:!0}),this.form.destroy(),this.form=!1,r.selected.blur()),r.selected&&(r.selected.$el.removeClass("selected"),r.selected=!1),this.trigger("editComplete"))},this.remove=function(e){var t=s(e)||this.selected;t.$el.hasClass("selected")&&this.deselect(),t&&(t.$el.fadeOut("fast",function(){this.remove(),$("#cb-starter").toggle(0===$("#cb-content > li").length)}),t.remove(),this.slices.splice(o(t.uuid),1))},this.duplicate=function(e){var i=s(e)||this.selected,o=new cobler.types[i.attributes.widgetType](this,$.extend(!0,{},i.attributes));o.validate(o.attributes,!1)&&(this.slices.push(o),t(o.createEL().insertAfter(i.$el).hide().show("highlight"))),o.callback&&o.callback.call(o)},this.addTypeDisplay=function(e){("all"===this.options.types||$.inArray(e.category,this.options.types)>-1)&&$(Berry.render("cobler_widget_cobler",e)).appendTo("#cb-source")};var t=function(e){$(e).hasClass("selected")||(r.deselect(),r.selected=s($(e).attr("id")),r.selected.$el.addClass("selected"),r.options.autoedit&&i(e))},i=function(e){r.form&&(r.form.destroy(),r.form=!1),r.selected.editView&&r.selected.$el.find(".cobler-li-content").html(r.selected.editView()),r.form=$("#cb-form").show().berry(s($(e).attr("id")).toFORM()),r.form.on("change",$.proxy(r.updateWidget,r)),r.trigger("edit")},s=function(e){for(var t in r.slices)if(r.slices[t].uuid==e)return r.slices[t];return!1},o=function(e){for(var t in r.slices)if(r.slices[t].uuid==e)return t;return!1};this.options=$.extend({name:Berry.getUID(),types:"all",target:"#content",axis:"",form:"#alt-sidebar",source:"#alt-sidebar",autoedit:!0,associative:!1,editable:!0,activeFormClass:"active"},e);var r=this;if(this.selected=!1,this.form=!1,this.slices=[],this.$el=$(this.options.target),this.clear(),$(this.options.form).empty(),$(this.options.source).empty(),0===$("#cb-source").length){$(this.options.source).append(Berry.render("cobler_controls_cobler",e));for(var c in cobler.types)this.addTypeDisplay(cobler.types[c].prototype)}$(this.options.target).off("click","#cb-content li span.remove-item"),$(this.options.target).on("click","#cb-content li span.remove-item",$.proxy(function(e){e.stopPropagation(),this.remove($(e.target).parents("li").attr("id"))},this)),$("body").off("click","#removeactive"),$(this.options.source).on("click","#removeactive",$.proxy(function(e){e.stopPropagation(),this.selected&&this.remove(this.selected.uuid)},this)),$(this.options.target).off("click","#cb-content li span.duplicate-item"),$(this.options.target).on("click","#cb-content li span.duplicate-item",$.proxy(function(e){e.stopPropagation(),this.duplicate($(e.target).parents("li").attr("id"))},this)),$(this.options.target).off("click","#cb-content > li"),$(this.options.source).off("click","#cb-source > li"),this.options.editable&&($(this.options.target).on("click","#cb-content > li",function(){t(this)}),$(this.options.source).on("click","#cb-source > li",$.proxy(function(e){e.stopPropagation(),this.add($(e.target).closest("li").data("name"))},this)));var n=null;$("#cb-source").sortable({connectWith:"#cb-content",forcePlaceholderSize:!0,helper:function(e,t){return t.clone().addClass("inUse").css({height:t.outerHeight(),width:t.outerWidth()}).insertAfter(t),t},placeholder:"cb-placeholder source",stop:$.proxy(function(e,i){if("cb-source"==$(i.item).parent().attr("id"))$(e.target).sortable("cancel"),$(".inUse").remove();else{var s=new(cobler.types[$(i.item).data("name")])(this);if(s.validate(s.attributes,!1)){this.slices.splice($(i.item).index(),0,s),cobler.changed=!0,$(".inUse").removeClass("inUse");var o=$(s.createEL());$(i.item).replaceWith(o),t(o.hide().show("highlight")),$("#cb-starter").hide()}else $(e.target).sortable("cancel"),$(".inUse").remove()}},this)}),window.onbeforeunload=function(){return cobler.changed?"Any changes that you made will be lost.":void 0},$(this.options.source).on("click","#showwidgets",$.proxy(function(){this.deselect()},this)),this.on("editComplete",function(){$("#showwidgets, .panel-heading").hide(),$("#cb-source").show()}),this.on("edit",function(){$("#showwidgets, .panel-heading").show(),$("#cb-source").hide()}),cobler.instances[this.options.name]=this}cobler.register=function(e){if(cobler.types[e.type]=cobler.slice.extend(e),$("#cb-source").length>0)for(var t in cobler.instances)cobler.instances[t].addTypeDisplay(e)},cobler.types={},cobler.slice=function(e,t){this.owner=e,this.attributes={},$.extend(!0,this.attributes,this.defaults,t,{widgetType:this.type}),this.uuid=Berry.getUID()},$.extend(cobler.slice.prototype,{createEL:function(){return this.$el=$(cb.options.editable?Berry.render("cobler_element_cobler",this):Berry.render("cobler_element_cobler_noedit",this)),this.$el.find(".cobler-li-content").append(this.toHTML()),this.$el},validate:function(){return!0},remove:function(){},blur:function(){},fields:[],toFORM:function(){return{label:this.display,options:{inline:!0},renderer:"tabs",tabsTarget:$("#alt-sidebar .panel-heading"),actions:!1,attributes:this.attributes,items:[],fields:this.fields}},toJSON:function(){return this.attributes=$.extend(this.attributes,this.owner.form.toJSON()),this.attributes},toHTML:function(){return"undefined"!=typeof this.template?"string"==typeof this.template?Berry.render(this.template,this.attributes):Berry.render(this.template(),this.attributes):$("<div/>")}}),cobler.instances={},cobler.slice.extend=Berry.field.extend,cobler.prototype.events={initialize:[]},cobler.prototype.addSub=Berry.prototype.addSub,cobler.prototype.on=Berry.prototype.on,cobler.prototype.off=Berry.prototype.off,cobler.prototype.trigger=Berry.prototype.trigger,cobler.changed=!1,$("body").keydown(function(e){switch(e.keyCode){case 27:if(typeof cb !== 'undefined'){cb.deselect()}}}); function cobler(e){this.clear=function(){this.deselect(),$("#cb-content").empty(),this.slices=[],this.$el.find("#cb-starter").remove(),this.$el.find("#cb-content").remove(),this.options.editable?(this.$el.append(Berry.render("cobler_init",this,e)),$("#cb-content").sortable({cursor:"move",items:"li:not(.locked)",placeholder:"cb-placeholder",forcePlaceholderSize:!0,axis:this.options.axis,start:function(e,t){$(".cb-placeholder").attr("data-name",$(t.item[0]).attr("data-name")).addClass($(t.item[0]).attr("class"))},stop:$.proxy(function(e,t){this.slices.splice($(t.item).index(),0,this.slices.splice(o($(t.item).attr("id")),1)[0]),cobler.changed=!0,this.trigger("change")},this),cancel:"#cb-content li .cobler-li-content, #cb-content li.locked",receive:function(){n=null}})):this.$el.append(Berry.render("cobler_init_noedit",this,e))},this.reload=function(){var e=this.toJSON();this.clear(),this.load(e)},this.load=function(e){this.clear();for(var t in e){$("#cb-starter").hide();var i=new cobler.types[e[t].widgetType](this,e[t]);i.validate(e[t],!1)&&($(i.createEL()).appendTo("#cb-content"),this.slices.push(i)),i.callback&&i.callback.call(i)}},this.toJSON=function(e){var e=$.extend({},this.options,e);if(e.associative){json={};for(var t in this.slices)json[this.slices[t].uuid]=this.slices[t].toJSON(!0);return json}json=[];for(var t in this.slices)json.push(this.slices[t].toJSON(!0));return json},this.toHTML=function(){var e=$("<div/>");for(var t in this.slices)e.append(this.slices[t].$el.find(".cobler-li-content").html());return e.html()},this.add=function(e,i){var s=new cobler.types[e](this,i);s.validate(s.defaults,!1)&&(this.slices.push(s),t(s.createEL().appendTo("#cb-content").hide().show("highlight")),$("#cb-starter").hide())},this.updateWidget=function(e){this.selected&&(this.selected.toJSON(!1),(1==e.force||"undefined"!=typeof e.path&&1==this.form.find(e.path).force||this.selected.contentFields!==!0)&&(r.selected.editView&&!e.force?(this.selected.$el.find(".cobler-li-content").html(this.selected.editView()),this.selected.contentFields&&this.form.each(function(){$("."+this.item.fieldset).append(this.$el)})):this.selected.$el.replaceWith($(this.selected.createEL()).addClass("selected"))),this.selected.callback&&this.selected.callback.call(this.selected)),cobler.changed=!0,this.trigger("change")},this.deselect=function(){r.selected&&(this.form&&(this.updateWidget({force:!0}),this.form.destroy(),this.form=!1),r.selected.blur(),r.selected.$el.removeClass("selected"),r.selected=!1,this.trigger("editComplete"))},this.remove=function(e){if(!this.options.confirm||confirm("Are you sure you want to delete this widget?")){var t=s(e)||this.selected;t.$el.hasClass("selected")&&this.deselect(),t&&(t.$el.fadeOut("fast",function(){this.remove(),$("#cb-starter").toggle(0===$("#cb-content > li").length)}),t.remove(),this.slices.splice(o(t.uuid),1))}},this.duplicate=function(e){var i=s(e)||this.selected,o=new cobler.types[i.attributes.widgetType](this,$.extend(!0,{},i.attributes));o.validate(o.attributes,!1)&&(this.slices.push(o),t(o.createEL().insertAfter(i.$el).hide().show("highlight"))),o.callback&&o.callback.call(o)},this.addTypeDisplay=function(e){("all"===this.options.types||$.inArray(e.category,this.options.types)>-1)&&$(Berry.render("cobler_widget",e)).appendTo("#cb-source")};var t=function(e){$(e).hasClass("selected")||(r.deselect(),r.selected=s($(e).attr("id")),r.selected.$el.addClass("selected"),r.options.autoedit&&i(e))},i=function(e){r.form&&(r.form.destroy(),r.form=!1),r.selected.editView&&r.selected.$el.find(".cobler-li-content").html(r.selected.editView()),r.form=$("#cb-form").show().berry(s($(e).attr("id")).toFORM()),r.form.on("change",$.proxy(r.updateWidget,r)),r.trigger("edit")},s=function(e){for(var t in r.slices)if(r.slices[t].uuid==e)return r.slices[t];return!1},o=function(e){for(var t in r.slices)if(r.slices[t].uuid==e)return t;return!1};this.options=$.extend({name:Berry.getUID(),types:"all",target:"#content",axis:"",form:"#alt-sidebar",source:"#alt-sidebar",autoedit:!0,associative:!1,editable:!0,confirm:!0,activeFormClass:"active"},e);var r=this;if(this.selected=!1,this.form=!1,this.slices=[],this.$el=$(this.options.target),this.clear(),$(this.options.form).empty(),$(this.options.source).empty(),0===$("#cb-source").length){$(this.options.source).append(Berry.render("cobler_controls",e));for(var c in cobler.types)this.addTypeDisplay(cobler.types[c].prototype)}0===$("#cb-form").length&&$(this.options.form).append(Berry.render("cobler_controls",e)),$(this.options.target).off("click","#cb-content li span.remove-item"),$(this.options.target).on("click","#cb-content li span.remove-item",$.proxy(function(e){e.stopPropagation(),this.remove($(e.target).parents("li").attr("id"))},this)),$("body").off("click","#removeactive"),$(this.options.source).on("click","#removeactive",$.proxy(function(e){e.stopPropagation(),this.selected&&this.remove(this.selected.uuid)},this)),$(this.options.target).off("click","#cb-content li span.duplicate-item"),$(this.options.target).on("click","#cb-content li span.duplicate-item",$.proxy(function(e){e.stopPropagation(),this.duplicate($(e.target).parents("li").attr("id"))},this)),$(this.options.target).off("click","#cb-content > li"),$(this.options.source).off("click","#cb-source > li"),this.options.editable&&($(this.options.target).on("click","#cb-content > li",function(){t(this)}),$(this.options.source).on("click","#cb-source > li",$.proxy(function(e){e.stopPropagation(),this.add($(e.target).closest("li").data("name")),cobler.changed=!0,this.trigger("change")},this)));var n=null;$("#cb-source").sortable({connectWith:"#cb-content",forcePlaceholderSize:!0,helper:function(e,t){return t.clone().addClass("inUse").css({height:t.outerHeight(),width:t.outerWidth()}).insertAfter(t),t},placeholder:"cb-placeholder source",stop:$.proxy(function(e,i){if("cb-source"==$(i.item).parent().attr("id"))$(e.target).sortable("cancel"),$(".inUse").remove();else{var s=new(cobler.types[$(i.item).data("name")])(this);if(s.validate(s.attributes,!1)){this.slices.splice($(i.item).index(),0,s),cobler.changed=!0,this.trigger("change"),$(".inUse").removeClass("inUse");var o=$(s.createEL());$(i.item).replaceWith(o),t(o.hide().show("highlight")),$("#cb-starter").hide()}else $(e.target).sortable("cancel"),$(".inUse").remove()}},this)}),$(this.options.source).on("click","#showwidgets",$.proxy(function(){this.deselect()},this)),this.on("editComplete",function(){$("#showwidgets, #alt-sidebar .panel-heading").hide(),$("#cb-source").show()}),this.on("edit",function(){$("#showwidgets, #alt-sidebar .panel-heading").show(),$("#cb-source").hide()}),cobler.instances[this.options.name]=this}function containsKey(e,t){var i={};for(var s in t)"undefined"!=typeof e[t[s]]&&(i[t[s]]=e[t[s]]);return i}cobler.register=function(e){if(cobler.types[e.type]=cobler.slice.extend(e),$("#cb-source").length>0)for(var t in cobler.instances)cobler.instances[t].addTypeDisplay(e)},cobler.types={},cobler.slice=function(e,t){this.owner=e,this.attributes={},$.extend(!0,this.attributes,this.defaults,t,{widgetType:this.type}),this.uuid=Berry.getUID()},$.extend(cobler.slice.prototype,{createEL:function(){return this.$el=$(cb.options.editable?Berry.render("cobler_element",this):Berry.render("cobler_element_noedit",this)),this.$el.find(".cobler-li-content").append(this.toHTML()),this.$el},validate:function(){return!0},remove:function(){},blur:function(){},fields:[],toFORM:function(){return{label:this.display,inline:!0,renderer:"tabs",tabsTarget:$("#alt-sidebar .panel-heading"),actions:!1,attributes:this.attributes,items:[],fields:this.fields}},toJSON:function(e){return e||(this.attributes=$.extend(this.attributes,this.owner.form.toJSON())),this.attributes},toHTML:function(){return"undefined"!=typeof this.template?"string"==typeof this.template?Berry.render(this.template,$.extend({},this.filter,this.attributes)):Berry.render(this.template(),$.extend({},this.filter,this.attributes)):$("<div/>")}}),cobler.instances={},cobler.slice.extend=Berry.field.extend,cobler.prototype.events={initialize:[]},cobler.prototype.addSub=Berry.prototype.addSub,cobler.prototype.on=Berry.prototype.on,cobler.prototype.off=Berry.prototype.off,cobler.prototype.trigger=Berry.prototype.trigger,cobler.changed=!1,$("body").keydown(function(e){switch(e.keyCode){case 27:if(typeof cb !== 'undefined'){cb.deselect()}}});